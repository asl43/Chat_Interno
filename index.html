<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Interno - Local de Trabalho</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        /* Login */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            width: 100%;
            max-width: 450px;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            color: white;
        }
        .login-title {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .login-subtitle {
            font-size: 14px;
            color: #666;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .password-wrapper {
            position: relative;
        }
        .password-wrapper input {
            padding-right: 50px;
        }
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 22px;
            padding: 5px;
            line-height: 1;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        .btn-secondary {
            width: 100%;
            padding: 14px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        .forgot-password {
            text-align: center;
            margin-top: 15px;
        }
        .forgot-password button {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 13px;
            text-decoration: underline;
        }
        .forgot-password button:hover {
            color: #667eea;
        }
        /* Chat */
        .chat-container {
            display: none;
            height: 100vh;
        }
        .chat-layout {
            display: flex;
            height: 100%;
        }
        .sidebar {
            width: 300px;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        .user-info {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 22px;
            overflow: hidden;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-name {
            font-weight: 600;
            font-size: 15px;
        }
        .user-status {
            font-size: 12px;
            color: #10b981;
        }
        .user-actions {
            display: flex;
            gap: 5px;
        }
        .icon-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .icon-btn:hover {
            background: #f5f5f5;
            color: #667eea;
        }
        .search-bar {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        .search-input:focus {
            border-color: #667eea;
        }
        .rooms-section {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 12px;
            margin-top: 15px;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .add-group-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 20px;
            padding: 2px;
        }
        .room-btn {
            width: 100%;
            padding: 12px 15px;
            border: none;
            background: none;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 6px;
            font-size: 14px;
            transition: all 0.3s;
            text-align: left;
        }
        .room-btn:hover {
            background: #f5f5f5;
        }
        .room-btn.active {
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            color: #667eea;
        }
        .room-icon {
            font-size: 18px;
        }
        .room-delete {
            margin-left: auto;
            color: #999;
            font-size: 16px;
            opacity: 0.7;
            transition: opacity 0.3s;
            padding: 0 5px;
        }
        .room-btn:hover .room-delete {
            opacity: 1;
        }
        .room-delete:hover {
            color: #ef4444;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        .chat-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .chat-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            overflow: hidden;
        }
        .chat-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-title {
            font-size: 22px;
            font-weight: 600;
        }
        .chat-subtitle {
            font-size: 13px;
            color: #666;
        }
        .chat-search {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            width: 250px;
        }
        .chat-search:focus {
            border-color: #667eea;
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .empty-state {
            text-align: center;
            color: #999;
            padding: 60px 20px;
        }
        .message {
            display: flex;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.own { justify-content: flex-end; }
        .message-bubble {
            max-width: 60%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .message.own .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .message:not(.own) .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }
        .message-user {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        .message-text {
            line-height: 1.4;
            font-family: Arial, sans-serif !important;
            text-transform: uppercase;
        }
        .message-time {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
        }
        .message-media {
            margin-top: 8px;
            max-width: 100%;
            border-radius: 8px;
        }
        .message-input-container {
            background: white;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            position: relative;
        }
        .message-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .emoji-btn, .mention-btn, .file-btn {
            width: 40px;
            height: 40px;
            background: #f5f5f5;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .file-btn { font-size: 18px; }
        .emoji-btn:hover, .mention-btn:hover, .file-btn:hover {
            background: #e0e0e0;
            transform: scale(1.1);
        }
        .emoji-picker {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 320px;
            z-index: 100;
        }
        .emoji-picker.show { display: flex; }
        .emoji-item {
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emoji-item:hover {
            background: #f5f5f5;
            transform: scale(1.2);
        }
        .message-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
        }
        .message-input:focus { border-color: #667eea; }
        .send-btn {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .send-btn:hover { transform: scale(1.05); }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 32px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }
        .close-btn:hover { color: #333; }
        .settings-section {
            margin-bottom: 25px;
        }
        .settings-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: block;
        }
        .avatar-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .avatar-option {
            width: 55px;
            height: 55px;
            border: 3px solid #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
        }
        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            box-shadow: 0 0 0 3px #667eea30;
        }
        .custom-avatar-upload {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .custom-avatar-preview {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #ccc;
        }
        .custom-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .hidden { display: none !important; }
        .highlight { background-color: #ffeb3b; padding: 2px 4px; border-radius: 3px; font-weight: 600; }
        @media (max-width: 768px) {
            .sidebar { width: 100%; max-width: 280px; }
            .message-bubble { max-width: 80%; }
            .chat-search { width: 150px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-icon">üë•</div>
                <h1 class="login-title">Chat Interno</h1>
                <p class="login-subtitle">Sistema de comunica√ß√£o da empresa</p>
            </div>
            <div class="form-group">
                <label>CPF</label>
                <input type="text" id="loginCpf" placeholder="000.000.000-00" maxlength="14">
            </div>
            <div class="form-group">
                <label>E-mail</label>
                <input type="email" id="loginEmail" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <div class="password-wrapper">
                    <input type="password" id="loginSenha" placeholder="Digite sua senha">
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
                </div>
            </div>
            <button class="btn-primary" onclick="handleAuth()">Cadastrar</button>
            <div class="forgot-password">
                <button type="button" onclick="showForgotPassword()">Esqueceu a senha? Fa√ßa um novo cadastro</button>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chatScreen" class="chat-container">
        <div class="chat-layout">
            <div class="sidebar">
                <div class="user-info" onclick="openSettings()">
                    <div class="user-avatar" id="userAvatar">üòä</div>
                    <div class="user-details">
                        <div class="user-name" id="userName"></div>
                        <div class="user-status">‚óè Online</div>
                    </div>
                    <div class="user-actions">
                        <button type="button" class="icon-btn" onclick="openSettings()" title="Configura√ß√µes">‚öôÔ∏è</button>
                        <button type="button" class="icon-btn" onclick="logout()" title="Sair">‚èèÔ∏è</button>
                    </div>
                </div>
                <div class="search-bar">
                    <input type="text" class="search-input" id="sidebarSearch" placeholder="üîç Buscar conversas..." onkeyup="filterRooms()">
                </div>
                <div class="rooms-section">
                    <div class="section-title">Salas</div>
                    <button type="button" class="room-btn active" onclick="switchRoom('aberta', 'sala')" data-room="aberta">
                        <span class="room-icon">üë•</span>
                        <span>Sala Aberta</span>
                    </button>
                    <button type="button" class="room-btn" onclick="switchRoom('privada', 'sala')" data-room="privada">
                        <span class="room-icon">üîí</span>
                        <span>Sala Privada</span>
                    </button>
                    <div class="section-title">
                        Grupos
                        <button type="button" class="add-group-btn" onclick="createGroup()" title="Criar grupo">‚ûï</button>
                    </div>
                    <div id="groupsList"></div>
                    <div class="section-title">Contatos Favoritos</div>
                    <div id="favoriteUsersList">
                        <p style="font-size: 13px; color: #999; padding: 0 15px;">Adicione um favorito usando o bot√£o @</p>
                    </div>
                </div>
            </div>
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <div class="chat-icon" id="chatIcon">üë•</div>
                        <div>
                            <div class="chat-title" id="chatTitle">Sala Aberta</div>
                            <div class="chat-subtitle" id="chatSubtitle">Todos os funcion√°rios podem visualizar</div>
                        </div>
                    </div>
                    <input type="text" class="chat-search" id="chatSearch" placeholder="üîç Buscar mensagens ou pessoas..." onkeyup="searchMessages()">
                </div>
                <div class="messages-container" id="messagesContainer">
                    <div class="empty-state">
                        <p>Nenhuma mensagem ainda.</p>
                        <p style="font-size: 13px; margin-top: 5px;">Seja o primeiro a enviar uma mensagem!</p>
                    </div>
                </div>
                <div class="message-input-container">
                    <div class="emoji-picker" id="emojiPicker"></div>
                    <div class="message-input-wrapper">
                        <button type="button" class="mention-btn" onclick="openUsersModal()" title="Lista de Usu√°rios e Favoritos">@</button>
                        <label for="fileInput" class="file-btn" title="Anexar Arquivo">üìé</label>
                        <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload()">
                        <button type="button" class="emoji-btn" onclick="toggleEmojiPicker()" title="Adicionar emoji">üòä</button>
                        <input type="text" class="message-input" id="messageInput" placeholder="Digite sua mensagem...">
                        <button type="button" class="send-btn" onclick="sendMessage()" title="Enviar mensagem">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Configura√ß√µes</h2>
                <button type="button" class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            <div class="settings-section">
                <label class="settings-label">Escolha seu avatar</label>
                <div class="avatar-options" id="avatarOptions"></div>
                <div class="custom-avatar-upload">
                    <label for="customAvatarInput" class="btn-secondary" style="padding:8px;font-size:13px;">Upload de Imagem</label>
                    <input type="file" id="customAvatarInput" accept="image/*" style="display:none;" onchange="setCustomAvatar(this)">
                    <div class="custom-avatar-preview" id="customAvatarPreview" style="display:none;">
                        <img id="customAvatarImg">
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <label class="settings-label">Nome de exibi√ß√£o no chat</label>
                <input type="text" class="settings-input" id="displayName" placeholder="Como voc√™ quer aparecer no chat">
            </div>
            <div class="settings-section">
                <label class="settings-label">Tamanho da Fonte (padr√£o 14)</label>
                <input type="number" class="settings-input" id="fontSizeSetting" min="10" max="24" value="14" placeholder="10 a 24 pixels">
            </div>
            <button type="button" class="btn-primary" onclick="saveSettings()">üíæ Salvar Configura√ß√µes</button>
        </div>
    </div>

    <!-- Users Modal -->
    <div id="usersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">@ Lista de Usu√°rios</h2>
                <button type="button" class="close-btn" onclick="closeUsersModal()">√ó</button>
            </div>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Clique em ‚ú® para adicionar um contato aos favoritos.</p>
            <div id="usersListContent" style="max-height: 40vh; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        let state = {
            currentUser: null,
            currentRoom: 'aberta',
            currentRoomType: 'sala',
            users: [],
            messages: { aberta: [], privada: [] },
            groups: [],
            favoriteUsers: [],
            chatSearchTerm: '',
            fontSize: 14
        };

        const emojis = ['üòä', 'üòÇ', 'ü§£', '‚ù§Ô∏è', 'üòç', 'ü•∞', 'üòò', 'üëç', 'üëè', 'üôå', 'üéâ', 'üî•', '‚ú®', 'üíØ', '‚≠ê', 'üåü', 'üí™', 'üëå', '‚úÖ', '‚ùå', 'üíº', 'üìä', 'üìà', 'üí°', 'üéØ', 'üöÄ', '‚ö°', 'üåà', '‚òÄÔ∏è', 'üåô'];
        const avatarEmojis = ['üòä', 'üòé', 'ü§ì', 'ü•≥', 'ü§©', 'üòá', 'üßê', 'ü§ó', 'ü§≠', 'ü•∏', 'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üßë‚Äçüíº', 'üë®‚Äçüíª', 'üë©‚Äçüíª', 'üßë‚Äçüíª', 'ü¶∏', 'ü¶π', 'üßô', 'üßö', 'üê±', 'üê∂', 'üêº', 'üê®', 'ü¶Å', 'üêØ', 'ü¶ä', 'üêª'];

        // Utilit√°rios
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeRegex(text) {
            return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Avatar personalizado
        function setCustomAvatar(input) {
            const file = input.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('customAvatarImg').src = e.target.result;
                document.getElementById('customAvatarPreview').style.display = 'block';
                // Remove sele√ß√£o de emojis
                document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
            };
            reader.readAsDataURL(file);
        }

        // Envio de arquivos
        function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                let mediaHtml = '';
                if (file.type.startsWith('image/')) {
                    mediaHtml = `<img src="${e.target.result}" class="message-media">`;
                } else if (file.type.startsWith('audio/')) {
                    mediaHtml = `<audio controls class="message-media"><source src="${e.target.result}" type="${file.type}">Seu navegador n√£o suporta √°udio.</audio>`;
                } else {
                    const icon = file.name.toLowerCase().endsWith('.pdf') ? 'üìÑ' : 'üìé';
                    mediaHtml = `${icon} <strong>${escapeHtml(file.name)}</strong> (${formatBytes(file.size)})<br><em style="font-size:12px;color:#666;">(Visualiza√ß√£o n√£o dispon√≠vel)</em>`;
                }
                sendMessage(mediaHtml, true); // true = √© m√≠dia
            };
            reader.readAsDataURL(file);
            fileInput.value = '';
        }

        // Login e autentica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            const cpfInput = document.getElementById('loginCpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', function(e) {
                    let v = e.target.value.replace(/\D/g, '');
                    if (v.length <= 11) {
                        v = v.replace(/(\d{3})(\d)/, '$1.$2')
                             .replace(/(\d{3})(\d)/, '$1.$2')
                             .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                        e.target.value = v;
                    }
                });
            }
            applyFontSize();
        });

        function togglePasswordVisibility() {
            const input = document.getElementById('loginSenha');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function handleAuth() {
            const cpf = document.getElementById('loginCpf').value.replace(/\D/g, '');
            const email = document.getElementById('loginEmail').value.trim();
            const senha = document.getElementById('loginSenha').value;
            if (!cpf || cpf.length !== 11) return alert('‚ö†Ô∏è CPF inv√°lido!');
            if (!email || !email.includes('@')) return alert('‚ö†Ô∏è E-mail inv√°lido!');
            if (!senha || senha.length < 4) return alert('‚ö†Ô∏è Senha curta demais!');
            if (state.users.find(u => u.cpf === cpf)) return alert('‚ö†Ô∏è CPF j√° cadastrado!');

            state.currentUser = {
                id: Date.now(),
                cpf,
                email,
                senha,
                displayName: email.split('@')[0],
                avatar: 'üòä',
                avatarType: 'emoji' // 'emoji' ou 'image'
            };
            state.users.push(state.currentUser);
            showChat();
        }

        function showForgotPassword() {
            alert('üìù Fa√ßa um novo cadastro com seus dados atualizados.');
            ['loginCpf','loginEmail','loginSenha'].forEach(id => document.getElementById(id).value = '');
        }

        function logout() {
            if (confirm('‚ùì Sair do chat?')) {
                state.currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('chatScreen').style.display = 'none';
            }
        }

        // Chat
        function showChat() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('chatScreen').style.display = 'block';
            updateUserDisplay();
            initEmojiPicker();
            renderGroups();
            renderFavoriteUsers();
            renderMessages();
        }

        function updateUserDisplay() {
            const nameEl = document.getElementById('userName');
            const avatarEl = document.getElementById('userAvatar');
            if (nameEl) nameEl.textContent = state.currentUser.displayName;
            if (avatarEl) {
                if (state.currentUser.avatarType === 'image') {
                    avatarEl.innerHTML = `<img src="${state.currentUser.avatar}" alt="Avatar">`;
                } else {
                    avatarEl.textContent = state.currentUser.avatar;
                    avatarEl.innerHTML = state.currentUser.avatar;
                }
            }
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const avatarOptions = document.getElementById('avatarOptions');
            avatarOptions.innerHTML = avatarEmojis.map(emoji => 
                `<div class="avatar-option ${state.currentUser.avatar === emoji && state.currentUser.avatarType === 'emoji' ? 'selected' : ''}" onclick="selectAvatar('${emoji}')">${emoji}</div>`
            ).join('');
            document.getElementById('displayName').value = state.currentUser.displayName;
            document.getElementById('fontSizeSetting').value = state.fontSize;
            const preview = document.getElementById('customAvatarPreview');
            const img = document.getElementById('customAvatarImg');
            if (state.currentUser.avatarType === 'image') {
                img.src = state.currentUser.avatar;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
            modal.classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function selectAvatar(emoji) {
            state.currentUser.avatar = emoji;
            state.currentUser.avatarType = 'emoji';
            document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.avatar-option').classList.add('selected');
            document.getElementById('customAvatarPreview').style.display = 'none';
        }

        function applyFontSize() {
            document.querySelectorAll('.message-text').forEach(el => {
                el.style.fontSize = `${state.fontSize}px`;
            });
        }

        function saveSettings() {
            const displayName = document.getElementById('displayName').value.trim();
            const newFontSize = parseInt(document.getElementById('fontSizeSetting').value);
            if (displayName) state.currentUser.displayName = displayName;
            if (newFontSize >= 10 && newFontSize <= 24) state.fontSize = newFontSize;
            updateUserDisplay();
            applyFontSize();
            closeSettings();
            renderMessages();
            alert('‚úÖ Configura√ß√µes salvas!');
        }

        // Usu√°rios e Favoritos
        function openUsersModal() {
            const list = document.getElementById('usersListContent');
            const others = state.users.filter(u => u.id !== state.currentUser.id);
            if (others.length === 0) {
                list.innerHTML = '<p style="padding:15px;text-align:center;">Nenhum outro usu√°rio.</p>';
                return;
            }
            list.innerHTML = others.map(u => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div class="user-avatar" style="width:35px;height:35px;font-size:18px;">${u.avatarType === 'image' ? `<img src="${u.avatar}" style="width:100%;height:100%;object-fit:cover;">` : u.avatar}</div>
                        <div><div style="font-weight:600;">${u.displayName}</div><div style="font-size:12px;color:#666;">${u.email}</div></div>
                    </div>
                    <button type="button" class="icon-btn" onclick="addFavoriteUser(${u.id})">${state.favoriteUsers.includes(u.id) ? '‚≠ê' : '‚ú®'}</button>
                </div>
            `).join('');
            document.getElementById('usersModal').classList.add('show');
        }

        function closeUsersModal() {
            document.getElementById('usersModal').classList.remove('show');
        }

        function addFavoriteUser(userId) {
            if (!state.favoriteUsers.includes(userId)) {
                state.favoriteUsers.push(userId);
                renderFavoriteUsers();
                openUsersModal(); // Atualiza modal
                alert('‚≠ê Adicionado aos favoritos!');
            }
        }

        function renderFavoriteUsers() {
            const container = document.getElementById('favoriteUsersList');
            const favs = state.users.filter(u => state.favoriteUsers.includes(u.id));
            if (favs.length === 0) {
                container.innerHTML = '<p style="font-size:13px;color:#999;padding:0 15px;">Adicione um favorito usando o bot√£o @</p>';
                return;
            }
            container.innerHTML = favs.map(u => `
                <button type="button" class="room-btn" onclick="switchToPrivate(${u.id})">
                    <span class="room-icon">${u.avatarType === 'image' ? `<img src="${u.avatar}" style="width:18px;height:18px;object-fit:cover;border-radius:50%;">` : u.avatar}</span>
                    <span>${u.displayName}</span>
                    <span class="room-delete" onclick="removeFavoriteUser(event, ${u.id})">‚ùå</span>
                </button>
            `).join('');
        }

        function removeFavoriteUser(e, userId) {
            e.stopPropagation();
            state.favoriteUsers = state.favoriteUsers.filter(id => id !== userId);
            renderFavoriteUsers();
            openUsersModal();
        }

        function switchToPrivate(userId) {
            const roomId = `user_${userId}`;
            if (!state.messages[roomId]) state.messages[roomId] = [];
            switchRoom(roomId, 'private', userId);
        }

        // Grupos
        function createGroup() {
            const name = prompt('Nome do grupo:');
            if (name && name.trim()) {
                const id = 'group_' + Date.now();
                state.groups.push({ id, name: name.trim(), icon: 'üë•' });
                state.messages[id] = [];
                renderGroups();
            }
        }

        function renderGroups() {
            const container = document.getElementById('groupsList');
            container.innerHTML = state.groups.map(g => `
                <button type="button" class="room-btn" onclick="switchRoom('${g.id}', 'group')">
                    <span class="room-icon">${g.icon}</span>
                    <span>${g.name}</span>
                    <span class="room-delete" onclick="deleteGroup(event, '${g.id}')">üóëÔ∏è</span>
                </button>
            `).join('');
        }

        function deleteGroup(e, id) {
            e.stopPropagation();
            if (confirm('Excluir grupo?')) {
                state.groups = state.groups.filter(g => g.id !== id);
                delete state.messages[id];
                if (state.currentRoom === id) switchRoom('aberta', 'sala');
                renderGroups();
            }
        }

        // Troca de sala
        function switchRoom(roomId, type, userId = null) {
            state.currentRoom = roomId;
            state.currentRoomType = type;
            document.querySelectorAll('.room-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.querySelector(`[data-room="${roomId}"]`) || document.querySelector(`.room-btn`);
            if (btn) btn.classList.add('active');

            let icon = 'üë•', title = 'Sala Aberta', subtitle = 'Todos podem visualizar';
            if (roomId === 'privada') {
                icon = 'üîí'; title = 'Sala Privada'; subtitle = 'Conversas confidenciais';
            } else if (type === 'group') {
                const g = state.groups.find(g => g.id === roomId);
                if (g) { icon = g.icon; title = g.name; subtitle = 'Grupo fechado'; }
            } else if (type === 'private') {
                const u = state.users.find(u => u.id === userId);
                if (u) {
                    icon = u.avatarType === 'image' ? `<img src="${u.avatar}" style="width:100%;height:100%;object-fit:cover;">` : u.avatar;
                    title = u.displayName;
                    subtitle = 'Mensagem privada';
                }
            }

            const iconEl = document.getElementById('chatIcon');
            if (typeof icon === 'string') {
                iconEl.textContent = icon;
                iconEl.innerHTML = icon;
            } else {
                iconEl.innerHTML = icon;
            }
            document.getElementById('chatTitle').textContent = title;
            document.getElementById('chatSubtitle').textContent = subtitle;

            state.chatSearchTerm = '';
            document.getElementById('chatSearch').value = '';
            renderMessages();
        }

        // Mensagens
        function sendMessage(text = null, isMedia = false) {
            const input = document.getElementById('messageInput');
            const msgText = text || input.value.trim();
            if (!msgText) return;

            const msg = {
                id: Date.now(),
                userId: state.currentUser.id,
                user: state.currentUser.displayName,
                avatar: state.currentUser.avatar,
                avatarType: state.currentUser.avatarType,
                text: msgText,
                timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                isMedia
            };

            if (!state.messages[state.currentRoom]) state.messages[state.currentRoom] = [];
            state.messages[state.currentRoom].push(msg);

            if (!text) input.value = '';
            renderMessages();
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            const msgs = state.messages[state.currentRoom] || [];

            if (msgs.length === 0 && !state.chatSearchTerm) {
                container.innerHTML = `<div class="empty-state"><p>Nenhuma mensagem ainda.</p><p style="font-size:13px;margin-top:5px;">Seja o primeiro a enviar!</p></div>`;
                return;
            }

            let filtered = msgs;
            if (state.chatSearchTerm) {
                const term = state.chatSearchTerm.toLowerCase();
                filtered = msgs.filter(m => m.text.toLowerCase().includes(term) || m.user.toLowerCase().includes(term));
            }

            if (filtered.length === 0 && state.chatSearchTerm) {
                container.innerHTML = `<div class="empty-state"><p>üîç Nenhum resultado para "${state.chatSearchTerm}"</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(msg => {
                const isOwn = msg.userId === state.currentUser.id;
                let userDisplay = msg.avatarType === 'image' 
                    ? `<img src="${msg.avatar}" style="width:16px;height:16px;border-radius:50%;vertical-align:middle;margin-right:5px;"> ${escapeHtml(msg.user)}`
                    : `${msg.avatar} ${escapeHtml(msg.user)}`;

                let textDisplay = msg.isMedia ? msg.text : escapeHtml(msg.text.toUpperCase());
                if (state.chatSearchTerm && !msg.isMedia) {
                    const regex = new RegExp(`(${escapeRegex(state.chatSearchTerm)})`, 'gi');
                    textDisplay = textDisplay.replace(regex, '<span class="highlight">$1</span>');
                }

                return `
                    <div class="message ${isOwn ? 'own' : ''}">
                        <div class="message-bubble">
                            <div class="message-user">${userDisplay}</div>
                            <div class="message-text" style="font-size:${state.fontSize}px;">${textDisplay}</div>
                            <div class="message-time">${msg.timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        function searchMessages() {
            state.chatSearchTerm = document.getElementById('chatSearch').value.trim();
            renderMessages();
        }

        function filterRooms() {
            const term = document.getElementById('sidebarSearch').value.toLowerCase();
            document.querySelectorAll('.room-btn').forEach(btn => {
                btn.style.display = btn.textContent.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        }

        // Emoji picker
        function initEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.innerHTML = emojis.map(e => `<span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>`).join('');
        }

        function toggleEmojiPicker() {
            document.getElementById('emojiPicker').classList.toggle('show');
        }

        function insertEmoji(emoji) {
            document.getElementById('messageInput').value += emoji;
            toggleEmojiPicker();
        }

        // Eventos
        document.addEventListener('click', function(e) {
            const picker = document.getElementById('emojiPicker');
            const btn = document.querySelector('.emoji-btn');
            if (picker && !picker.contains(e.target) && (!btn || !btn.contains(e.target))) {
                picker.classList.remove('show');
            }
            if (e.target === document.getElementById('settingsModal')) closeSettings();
            if (e.target === document.getElementById('usersModal')) closeUsersModal();
        });

        document.addEventListener('keypress', function(e) {
            if (e.target.id === 'messageInput' && e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            if (['loginCpf','loginEmail','loginSenha'].includes(e.target.id) && e.key === 'Enter') {
                e.preventDefault();
                handleAuth();
            }
        });
    </script>
</body>
</html>
